{% extends "base1.html" %}
{% block content %}
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>自动化测试执行</legend>
    </fieldset>
    <table id="jobs" lay-filter="jobs">
        <input style="display: none" id="csrf" value={{ options.csrf_token }}>
    </table>
{% endblock %}
{% load static %}
{% block script %}
    <script type="text/html" id="selectNode">
        <select name="node" lay-filter="node" id="node" required lay-verify="required">
            <option value="none">---</option>
            {% if options.nodes %}
                {% for opt in options.nodes %}
                    <option value="{{ opt.ip_port }}">{{ opt.ip_port }}-{{ opt.tag }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </script>
    <script type="text/html" id="operations">
        <a class="layui-btn layui-btn-xs" lay-event="exec">执行</a>
    </script>
    <script>
        !function () {
            let table = layui.table;
            let form = layui.form;
            let $ = layui.$;
            let layer = layui.layer;
            {# 左侧菜单展开 #}
            let expand = layui.sessionData('expand').expand;

            let jobs = table.render(
                {
                    elem: '#jobs'
                    , id: ''
                    , height: 'full'
                    , url: '/autotest/jobs/get/' {# 数据接口 #}
                    , where: {}
                    , page: {
                        curr: 1,
                        limit: 10
                    }
                    , even: true
                    , cols: [[
                        {field: 'group', title: 'TestGroup', sort: true, align: 'center'}
                        , {field: 'suite', title: 'TestSuit', sort: true, align: 'center'}
                        , {field: 'func', title: 'NodeFunction', sort: true, align: 'center'}
                        , {field: 'mthd', title: 'TestMethod', sort: true, align: 'center'}
                        , {field: 'ds_range', title: 'Range', sort: true, edit: 'text', align: 'center'}
                        , {field: 'comment', title: 'Comment', edit: 'text'}
                        , {field: 'node', title: 'Node', templet: '#selectNode'}
                        , {field: 'status', title: 'Status', align: 'center'}
                        , {field: '', title: 'Action', align: 'center', toolbar: '#operations', width: 80}
                    ]]
                    , done: function (res, curr, count) {
                        {#设置select样式#}
                        $(".layui-table-body, .layui-table-box, td[data-field='node']>.layui-table-cell").css('overflow', 'visible');
                        $(".layui-form-select").css({
                            'margin-top': '-10px',
                            'margin-left': '-15px',
                            'margin-right': '-15px'
                        });
                        let exp = res.expand;
                        if ('' !== exp && exp != null) {
                            $("." + exp).parent().attr("class", "layui-nav-item layui-nav-itemed");
                        }
                    }
                }
            );
            {#工具条监听#}
            table.on('tool(jobs)', function (obj) {
                    let data = obj.data;
                    {# 行数据 #}
                    let layEvent = obj.event;
                    {# 事件值 #}
                    let tr = obj.tr;
                    {# 行DOM对象 #}
                    {#console.log('data:' + data);#}
                    {#console.log('event: ' + layEvent);#}
                    {#console.log('tr: ' + tr);#}
                    {#console.log(tr.attr('data-index')); //行序号#}
                    let func = data.func;
                    let mthd = data.mthd;
                    let ds_range = data.ds_range;
                    let comment = data.comment;
                    let index = tr.attr('data-index');
                    let locator = "tr[data-index= " + index.toString() + "] select#node";
                    let node = $(locator).val();
                    const csrf = $("#csrf").val();
                    //console.log(node);
                    if (node === 'none') {
                        layer.open({
                            content: '<div style="padding: 20px 100px;">' + '请选择执行节点!' + '</div>'
                            , type: 1
                            , title: '提示'
                            , time: 5000
                            , btn: '确定'
                            , yes: function () {
                                layer.closeAll();
                            }
                        });
                    } else {
                        {#执行#}
                        $.ajax({
                            url: "/autotest/job/exec/"
                            , type: "POST"
                            , beforeSend: function (xhr) {
                                xhr.setRequestHeader("X-CSRFToken", csrf);
                            }
                            , data: {func: func, mthd: mthd, ds_range: ds_range, node: node, comment: comment}
                            , success: function (data, textStatus) {
                                console.log(data);
                                layer.open({
                                    content: '<div style="padding: 20px 100px;">' + data.msg + '</div>'
                                    , type: 1
                                    , title: '提示'
                                    , time: 5000
                                    , btn: '确定'
                                    , yes: function () {
                                        layer.closeAll();
                                    }
                                });
                            }
                        });
                    }
                }
            )

        }()
    </script>

{% endblock %}